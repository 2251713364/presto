#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <string.h>

#ifndef _FCOMPLEX_DECLARE_T_
typedef struct FCOMPLEX {
  float r, i;
} fcomplex;

#define _FCOMPLEX_DECLARE_T_
#endif				/* _FCOMPLEX_DECLARE_T_ */

#ifndef _FRAWTYPE_DECLARE_T_
typedef fcomplex rawtype;
#define _FRAWTYPE_DECLARE_T_
#endif				/* _FRAWTYPE_DECLARE_T_ */


static long rnd2down(long x);
static long sqrt4down(long x);

/* Routines used to calculate memory characteristics */

static long rnd2down(long x)
{
  long r = 1;

  if (!x)
    return 0;
  while (x >>= 1)
    r <<= 1;
  return r;
}

static long sqrt4down(long x)
{
  long r = 1;

  if (!x)
    return 0;
  while (x >>= 2)
    r <<= 1;
  return r;
}


#ifdef USEDMALLOC
#include "dmalloc.h"
#endif

int main(void)
{
  long CODESIZE;
  long Ramsize;
  long CacheL1size;
  long CacheL2size;
  long Cacheburst;
  long Cachetreshold;
  long Cacheburstblocksize;
  long Cacheblocksize;
  long Maxblocksize;
  FILE *memfile;

  printf("\nThis program will generate the meminfo.h for the Fastfft Library.\n\n");

  memfile = fopen("../include/meminfo.h", "w+");

  fprintf(memfile, "/* The following definitions can be changed to tweak your    */\n");
  fprintf(memfile, "/* code.  But they probably won't help a whole lot.  You     */\n");
  fprintf(memfile, "/* can calculate their values by running meminit.            */\n");
  fprintf(memfile, "/* This file was generated by running 'meminit'.             */\n");

  /* Approximate code size of program in Mb: */

  CODESIZE = 2;
  fprintf(memfile, "#define CODESIZE              %ld\n", CODESIZE);

  /* RAM size                                                    */
  /* Set this to the amount of RAM you want the program to use:  */
  /* Ramsize = 8 * (1 << 20) (where 8 is in Mb);                 */

  printf("Enter the amount of memory you would like to allocate\n");
  printf("  for this program in Mb (this is per processor):\n");
  scanf("%ld", &Ramsize);
  Ramsize *= (1 << 20);
  fprintf(memfile, "#define Ramsize               %ld\n", Ramsize);

  /* L1 cache size                                               */
  /* 486's and Pentiums have 8KB (data) L1 cache                 */

  printf("Enter the L1 cache size per processor in kb.:\n");
  scanf("%ld", &CacheL1size);
  CacheL1size *= (1 << 10);
  fprintf(memfile, "#define CacheL1size           %ld\n", CacheL1size);

  /* L2 cache size */
  /* set to amount of L2 cache */

  printf("Enter the size of each processor's L2 cache in kb:\n");
  scanf("%ld", &CacheL2size);
  CacheL2size *= (1 << 10);
  fprintf(memfile, "#define CacheL2size           %ld\n", CacheL2size);

  /* cache burst width                                           */
  /* 16 bytes for 486, 32 for Pentium                            */

  printf("Enter the burst width for each processor in bytes\n");
  printf("  (486 = 16 bytes, Pentium = 32 bytes):\n");
  scanf("%ld", &Cacheburst);
  fprintf(memfile, "#define Cacheburst            %ld\n", Cacheburst);

  /* Set to the maximum 2^n size block of modints that fits in the memory */

  Maxblocksize = rnd2down((long) (Ramsize / sizeof(rawtype)));
  fprintf(memfile, "#define Maxblocksize          %ld\n", Maxblocksize);

  /*  Maximum size of FFT (real numbers) to do in memory    */

  fprintf(memfile, "#define MAXREALFFT            %ld\n", Maxblocksize * 2);

  /*  Maximum size for FFTW (real numbers) to do in memory    */

  fprintf(memfile, "#define BIGFFTWSIZE           2000000\n");

  /*  KBF (from fourfs.c) */

  fprintf(memfile, "#define KBF                   %ld\n", Maxblocksize / 2);

  /* Size of matrix that fits in L2 cache                        */

  Cachetreshold = rnd2down((long) (CacheL2size / sizeof(rawtype)));
  fprintf(memfile, "#define Cachetreshold         %ld\n", Cachetreshold);

  /* Cache burst in rawtype                                      */

  Cacheburstblocksize = rnd2down((long) (Cacheburst / sizeof(rawtype)));
  fprintf(memfile, "#define Cacheburstblocksize   %ld\n", Cacheburstblocksize);
  /* Transpose block size, fits in processor L1 cache            */

  Cacheblocksize = sqrt4down((long) (CacheL1size / sizeof(rawtype)));
  fprintf(memfile, "#define Cacheblocksize        %ld\n", Cacheblocksize);

  fclose(memfile);

  printf("\nResults are: \n\n");
  printf("Ramsize               = %ld\n", Ramsize);
  printf("CacheL1size           = %ld\n", CacheL1size);
  printf("CacheL2size           = %ld\n", CacheL2size);
  printf("Cacheburst            = %ld\n", Cacheburst);
  printf("Cachetreshold         = %ld\n", Cachetreshold);
  printf("Cacheburstblocksize   = %ld\n", Cacheburstblocksize);
  printf("Cacheblocksize        = %ld\n", Cacheblocksize);
  printf("Maxblocksize          = %ld\n", Maxblocksize);
  printf("MAXREALFFT            = %ld\n", Maxblocksize * 2);
  printf("BIGFFTWSIZE           = 2000000\n");
  printf("KBF                   = %ld\n", Maxblocksize / 2);
  printf("\n\n");

  exit(0);
}
